# Weaviate æ•°æ®åº“æ ¸å¿ƒé€»è¾‘è¯¦è§£

## ğŸ“Š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ News2Context é¡¹ç›®ä¸­ Weaviate å‘é‡æ•°æ®åº“çš„å·¥ä½œåŸç†ã€åµŒå…¥æ–¹å¼å’Œæœç´¢æœºåˆ¶ã€‚

---

## 1. æ•°æ®å­˜å‚¨ç»“æ„

### 1.1 ä¸åˆ‡å‰² Chunks - æ•´ç¯‡æ–‡ç« å­˜å‚¨

```python
# æ¯æ¡æ–°é—»ä½œä¸ºä¸€ä¸ªå®Œæ•´å¯¹è±¡å­˜å‚¨
{
    "task_name": "news-task",
    "title": "æ–°é—»æ ‡é¢˜",
    "content": "å®Œæ•´æ­£æ–‡å†…å®¹ï¼ˆå¯èƒ½å¾ˆé•¿ï¼Œä¸åˆ‡å‰²ï¼‰",  # â† å…³é”®ï¼
    "url": "https://...",
    "source_name": "åå°”è¡—è§é—»",
    "source_hashid": "abc123",
    "published_at": "2025-11-26T21:00:00Z",
    "fetched_at": "2025-11-26T21:00:00Z",
    "category": "è´¢ç»",
    "excerpt": "æ‘˜è¦"
}
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- âŒ **ä¸åˆ‡å‰²æˆ chunks** - æ¯æ¡æ–°é—»æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡
- âœ… **æ•´ç¯‡å‘é‡åŒ–** - æ ‡é¢˜ + æ­£æ–‡ä¸€èµ·ç”Ÿæˆä¸€ä¸ªå‘é‡
- âš ï¸ **é•¿åº¦é™åˆ¶** - å—åµŒå…¥æ¨¡å‹ token é™åˆ¶ï¼ˆ8191 tokensï¼‰

### 1.2 ä¸ºä»€ä¹ˆä¸åˆ‡å‰²ï¼Ÿ

**ä¼˜ç‚¹**ï¼š
- âœ… ä¿æŒè¯­ä¹‰å®Œæ•´æ€§
- âœ… æœç´¢æ—¶è¿”å›å®Œæ•´æ–‡ç« 
- âœ… ç®€åŒ–æ•°æ®ç»“æ„

**ç¼ºç‚¹**ï¼š
- âŒ é•¿æ–‡ç« å¯èƒ½è¶…è¿‡ token é™åˆ¶
- âŒ æ— æ³•ç²¾ç¡®å®šä½åˆ°æ–‡ç« çš„æŸä¸ªæ®µè½
- âŒ å‘é‡å¯èƒ½ä¸å¤Ÿç²¾ç¡®ï¼ˆå¤ªé•¿çš„å†…å®¹ï¼‰

---

## 2. å‘é‡åŒ–é…ç½®

### 2.1 ä½¿ç”¨çš„åµŒå…¥æ¨¡å‹

```python
"vectorizer": "text2vec-openai",
"moduleConfig": {
    "text2vec-openai": {
        "model": "text-embedding-3-large",  # OpenAI æœ€æ–°åµŒå…¥æ¨¡å‹
        "type": "text",
        "baseURL": "https://litellm.futurx.cc"  # é€šè¿‡ LiteLLM ä»£ç†
    }
}
```

**æ¨¡å‹è§„æ ¼**ï¼š
- æ¨¡å‹: `text-embedding-3-large`
- ç»´åº¦: 3072 ç»´
- æœ€å¤§ tokens: **8191 tokens**
- æˆæœ¬: $0.13 / 1M tokens

### 2.2 å“ªäº›å­—æ®µå‚ä¸å‘é‡åŒ–ï¼Ÿ

| å­—æ®µ | å‚ä¸å‘é‡åŒ– | è¯´æ˜ |
|------|-----------|------|
| `title` | âœ… æ˜¯ | æ–°é—»æ ‡é¢˜ |
| `content` | âœ… æ˜¯ | æ­£æ–‡å†…å®¹ |
| `source_name` | âœ… æ˜¯ | æ¥æºåç§° |
| `category` | âœ… æ˜¯ | åˆ†ç±» |
| `excerpt` | âœ… æ˜¯ | æ‘˜è¦ |
| `url` | âŒ å¦ | è·³è¿‡ï¼ˆ`skip: True`ï¼‰ |
| `task_name` | âŒ å¦ | è·³è¿‡ |
| `source_hashid` | âŒ å¦ | è·³è¿‡ |
| `published_at` | âŒ å¦ | æ—¥æœŸä¸å‚ä¸ |
| `fetched_at` | âŒ å¦ | æ—¥æœŸä¸å‚ä¸ |

**å‘é‡åŒ–è¿‡ç¨‹**ï¼š
```
title + content + source_name + category + excerpt
                â†“
        OpenAI Embedding API
                â†“
        3072 ç»´å‘é‡
                â†“
        å­˜å‚¨åˆ° Weaviate
```

---

## 3. æ‰¹é‡æ’å…¥é€»è¾‘

### 3.1 å½“å‰å®ç°

```python
def batch_insert_news(self, collection_name: str, news_list: List[Dict], batch_size: int = 20):
    """æ‰¹é‡æ’å…¥æ–°é—»"""
    
    # é…ç½®æ‰¹é‡æ’å…¥
    self.client.batch.configure(
        batch_size=20,         # æ¯æ‰¹ 20 æ¡
        dynamic=True,          # åŠ¨æ€è°ƒæ•´
        timeout_retries=3,     # é‡è¯• 3 æ¬¡
        callback=None
    )
    
    with self.client.batch as batch:
        for news in news_list:
            # æ£€æŸ¥å†…å®¹é•¿åº¦
            content_length = len(news.get('title', '')) + len(news.get('content', ''))
            if content_length > 30000:  # çº¦ 8000 tokens
                logger.warning(f"å†…å®¹è¿‡é•¿ï¼Œè·³è¿‡")
                continue
            
            batch.add_data_object(
                data_object=news,
                class_name=collection_name
            )
```

### 3.2 æ‰¹é‡æ’å…¥æµç¨‹

```
277 æ¡æ–°é—»
    â†“
åˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ‰¹ 20 æ¡ï¼‰
    â†“
æ‰¹æ¬¡ 1: 20 æ¡ â†’ å‘é‡åŒ– â†’ æ’å…¥
æ‰¹æ¬¡ 2: 20 æ¡ â†’ å‘é‡åŒ– â†’ æ’å…¥
...
æ‰¹æ¬¡ 14: 17 æ¡ â†’ å‘é‡åŒ– â†’ æ’å…¥
    â†“
æ£€æŸ¥ç»“æœ
```

### 3.3 å¯èƒ½çš„å¤±è´¥åŸå› 

1. **å†…å®¹è¿‡é•¿**
   - è¶…è¿‡ 8191 tokens
   - å½“å‰é™åˆ¶: 30000 å­—ç¬¦ï¼ˆçº¦ 8000 tokensï¼‰

2. **å‘é‡åŒ–å¤±è´¥**
   - OpenAI API è°ƒç”¨å¤±è´¥
   - ç½‘ç»œè¶…æ—¶

3. **é‡å¤æ•°æ®**
   - Weaviate å¯èƒ½è·³è¿‡é‡å¤æ•°æ®

4. **æ‰¹é‡æ’å…¥è¶…æ—¶**
   - æ‰¹é‡å¤§å°å¤ªå¤§
   - ç½‘ç»œä¸ç¨³å®š

---

## 4. æœç´¢æ–¹å¼

### 4.1 å½“å‰å®ç° - çº¯è¯­ä¹‰æœç´¢

```python
def search_news(self, collection_name: str, query: str, limit: int = 10):
    """è¯­ä¹‰æœç´¢æ–°é—»"""
    result = (
        self.client.query
        .get(collection_name, [
            "task_name", "title", "content", "url",
            "source_name", "published_at", "category", "excerpt"
        ])
        .with_near_text({"concepts": [query]})  # â† çº¯è¯­ä¹‰æœç´¢
        .with_limit(limit)
        .with_additional(["certainty", "id"])  # è¿”å›ç›¸ä¼¼åº¦åˆ†æ•°
        .do()
    )
```

### 4.2 æœç´¢ç±»å‹å¯¹æ¯”

| æœç´¢ç±»å‹ | å½“å‰ä½¿ç”¨ | è¯´æ˜ |
|---------|---------|------|
| **è¯­ä¹‰æœç´¢** | âœ… æ˜¯ | åŸºäºå‘é‡ç›¸ä¼¼åº¦ |
| **å…³é”®è¯æœç´¢** | âŒ å¦ | ç²¾ç¡®åŒ¹é…å…³é”®è¯ |
| **æ··åˆæœç´¢** | âŒ å¦ | è¯­ä¹‰ + å…³é”®è¯ç»“åˆ |
| **å…¨æ–‡æœç´¢** | âŒ å¦ | æ”¯æŒå¤æ‚æŸ¥è¯¢ |

### 4.3 è¯­ä¹‰æœç´¢ç¤ºä¾‹

```python
# ç”¨æˆ·æŸ¥è¯¢
query = "äººå·¥æ™ºèƒ½å¯¹ç»æµçš„å½±å“"

# Weaviate å¤„ç†
1. å°†æŸ¥è¯¢å‘é‡åŒ– â†’ 3072 ç»´å‘é‡
2. è®¡ç®—ä¸æ‰€æœ‰æ–°é—»å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
3. è¿”å›æœ€ç›¸ä¼¼çš„ 10 æ¡æ–°é—»

# ç»“æœ
[
    {"title": "AI æ¨åŠ¨ç»æµå¢é•¿", "certainty": 0.92},
    {"title": "äººå·¥æ™ºèƒ½æ”¹å˜äº§ä¸šç»“æ„", "certainty": 0.89},
    ...
]
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç†è§£è¯­ä¹‰ï¼Œä¸åªæ˜¯å…³é”®è¯
- âœ… å¯ä»¥æ‰¾åˆ°ç›¸å…³ä½†ç”¨è¯ä¸åŒçš„å†…å®¹

**ç¼ºç‚¹**ï¼š
- âŒ æ— æ³•ç²¾ç¡®åŒ¹é…ç‰¹å®šè¯æ±‡
- âŒ å¯èƒ½é—æ¼åŒ…å«å…³é”®è¯ä½†è¯­ä¹‰ä¸åŒçš„å†…å®¹

---

## 5. ä¸ºä»€ä¹ˆåªå…¥åº“äº† 19 æ¡ï¼Ÿ

### 5.1 è¯Šæ–­æ­¥éª¤

æ ¹æ®æ‚¨çš„æƒ…å†µï¼ˆ277æ¡é‡‡é›†ï¼Œ19æ¡å…¥åº“ï¼‰ï¼Œå¯èƒ½åŸå› ï¼š

#### åŸå›  1: å†…å®¹è¿‡é•¿
```python
# æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹è¿‡é•¿çš„æ–°é—»
for news in news_list:
    length = len(news['title']) + len(news['content'])
    if length > 30000:
        print(f"è¿‡é•¿: {news['title']} ({length} å­—ç¬¦)")
```

#### åŸå›  2: å‘é‡åŒ–å¤±è´¥
```python
# æŸ¥çœ‹ Weaviate æ—¥å¿—
# å¯èƒ½æ˜¾ç¤º OpenAI API é”™è¯¯
```

#### åŸå›  3: æ‰¹é‡æ’å…¥é”™è¯¯
```python
# æ–°ä»£ç ä¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯
logger.error(f"æ·»åŠ æ–°é—» #{idx} å¤±è´¥: {str(e)}")
```

### 5.2 ä¿®å¤åçš„æ”¹è¿›

æ–°ä»£ç å¢åŠ äº†ï¼š
1. âœ… **å†…å®¹é•¿åº¦æ£€æŸ¥** - è¶…è¿‡ 30000 å­—ç¬¦è‡ªåŠ¨è·³è¿‡
2. âœ… **è¯¦ç»†é”™è¯¯æ—¥å¿—** - è®°å½•æ¯æ¡å¤±è´¥çš„æ–°é—»
3. âœ… **ç»Ÿè®¡ä¿¡æ¯** - æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ•°é‡
4. âœ… **æ‰¹é‡ç»Ÿè®¡** - æ˜¾ç¤º Weaviate æ‰¹é‡æ’å…¥ç»Ÿè®¡

---

## 6. ä¼˜åŒ–å»ºè®®

### 6.1 çŸ­æœŸä¼˜åŒ–ï¼ˆå·²å®ç°ï¼‰

1. âœ… **æ·»åŠ é•¿åº¦æ£€æŸ¥** - è·³è¿‡è¿‡é•¿å†…å®¹
2. âœ… **è¯¦ç»†é”™è¯¯æ—¥å¿—** - ä¾¿äºè¯Šæ–­é—®é¢˜
3. âœ… **æ‰¹é‡ç»Ÿè®¡** - äº†è§£æ’å…¥æƒ…å†µ

### 6.2 ä¸­æœŸä¼˜åŒ–ï¼ˆå»ºè®®ï¼‰

1. **å†…å®¹æˆªæ–­è€Œä¸æ˜¯è·³è¿‡**
   ```python
   # æˆªå–å‰ N ä¸ªå­—ç¬¦è€Œä¸æ˜¯å®Œå…¨è·³è¿‡
   if content_length > 30000:
       news['content'] = news['content'][:25000] + "..."
   ```

2. **æ·»åŠ é‡è¯•æœºåˆ¶**
   ```python
   # å¤±è´¥çš„æ–°é—»å•ç‹¬é‡è¯•
   for failed_news in failed_list:
       retry_insert(failed_news)
   ```

3. **åˆ†æ‰¹æ¬¡æ›´å°**
   ```python
   # é™ä½æ‰¹é‡å¤§å°ï¼Œæé«˜æˆåŠŸç‡
   batch_size = 10  # ä» 20 é™åˆ° 10
   ```

### 6.3 é•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **å®ç° Chunk åˆ‡å‰²**
   ```python
   # é•¿æ–‡ç« åˆ‡å‰²æˆå¤šä¸ª chunks
   def split_into_chunks(content, max_length=5000):
       chunks = []
       for i in range(0, len(content), max_length):
           chunks.append(content[i:i+max_length])
       return chunks
   ```

2. **æ··åˆæœç´¢**
   ```python
   # ç»“åˆè¯­ä¹‰æœç´¢å’Œå…³é”®è¯æœç´¢
   .with_hybrid(query=query, alpha=0.75)  # 75% è¯­ä¹‰, 25% å…³é”®è¯
   ```

3. **æ·»åŠ  BM25 ç´¢å¼•**
   ```python
   # å¯ç”¨ BM25 å…³é”®è¯æœç´¢
   "invertedIndexConfig": {
       "bm25": {
           "enabled": True
       }
   }
   ```

---

## 7. æµ‹è¯•å’ŒéªŒè¯

### 7.1 æ£€æŸ¥å…¥åº“æ•°é‡

```python
# æŸ¥çœ‹å®é™…å…¥åº“æ•°é‡
stats = collection_manager.get_collection_stats("NewsTask")
print(f"å®é™…å…¥åº“: {stats['total_objects']} æ¡")
```

### 7.2 æµ‹è¯•æœç´¢

```python
# æµ‹è¯•è¯­ä¹‰æœç´¢
results = collection_manager.search_news(
    collection_name="NewsTask",
    query="äººå·¥æ™ºèƒ½",
    limit=5
)
print(f"æœç´¢åˆ° {len(results)} æ¡ç»“æœ")
```

### 7.3 æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

é‡æ–°è¿è¡Œé‡‡é›†ä»»åŠ¡ï¼ŒæŸ¥çœ‹æ–°çš„è¯¦ç»†æ—¥å¿—ï¼š
```
æ‰¹é‡æ’å…¥å®Œæˆ: æˆåŠŸ 250, å¤±è´¥ 27, æ€»è®¡ 277
æ–°é—» #15 å†…å®¹è¿‡é•¿ (35000 å­—ç¬¦)ï¼Œè·³è¿‡
æ–°é—» #42 æ·»åŠ å¤±è´¥: OpenAI API timeout
...
```

---

## 8. æ€»ç»“

### å½“å‰æ¶æ„

```
æ–°é—»é‡‡é›†
    â†“
æ•´ç¯‡æ–‡ç« ï¼ˆä¸åˆ‡å‰²ï¼‰
    â†“
å‘é‡åŒ–ï¼ˆOpenAI text-embedding-3-largeï¼‰
    â†“
æ‰¹é‡æ’å…¥ Weaviateï¼ˆæ¯æ‰¹ 20 æ¡ï¼‰
    â†“
çº¯è¯­ä¹‰æœç´¢ï¼ˆwith_near_textï¼‰
```

### å…³é”®é™åˆ¶

- âš ï¸ æœ€å¤§é•¿åº¦: 8191 tokensï¼ˆçº¦ 30000 å­—ç¬¦ï¼‰
- âš ï¸ ä¸åˆ‡å‰² chunks
- âš ï¸ çº¯è¯­ä¹‰æœç´¢ï¼ˆæ— å…³é”®è¯åŒ¹é…ï¼‰

### ä¸‹ä¸€æ­¥

1. è¿è¡Œæ–°ä»£ç ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—
2. ç¡®è®¤å¤±è´¥åŸå› 
3. æ ¹æ®æ—¥å¿—è°ƒæ•´ç­–ç•¥ï¼ˆæˆªæ–­ vs è·³è¿‡ï¼‰
